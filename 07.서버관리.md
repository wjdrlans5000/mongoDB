# 서버관리
- 몽고DB 시작과 중지
- 보안 관련 옵션
- 로깅 고려 사항

## 몽고DB 시작과 중지
- mongod 실행 파일로 시작
- mongod --help

### 주로 사용되는 옵션
- --dbpath : 데이터 디렉터리로 사용할 경로 지정 (기본값: /data/db)
- --port : 서버가 연결을 대기할 포트 번호 지정 (기본값: 27017)
- --fork : 서버 프로세스를 포크(생성)해서 몽고DB를 데몬으로 작동시킴
- --logpath : 모든 출력을 명령행에 표시하지 않고 지정한 파일로 출력, 예전 로그를 지우지 않고 남기려면 --logappend 옵션 함께 사용
- --directoryperdb : 각 데이터베이스를 자신의 디렉터리에 저장
- --config : 옵션을 추가하는 용도의 구성파일을 사용
  - 서버가 구성 파일에서 옵션을 받게 하려면 -f나 --config 플래그 사용 (mongod --config ~/.mongodb.conf)

### 몽고DB 중지하기
- shutdown 명령을 사용
  - 관리자 명령이며 admin 데이터베이스에서 실행해야 한다.
```
> use admin
switched to db admin
> db.showdownServer()
server should be down...
```
- 프라이머리에서 실행중일 때, shutdown 명령은 서버가 중지하기 전에 프라이머리를 강등한 후 세컨더리가 따라잡도록 대기.
- force 옵션을 사용하면 프라이머리를 중지시키도록 shutdown 명령을 강제할수 있다.

## 보안
- 서버를 공개적으로 접근할수 있게 설정하지 말고 외부환경 사이의 연결은 가능한 엄격히 제한

### 보안 관련 옵션
- --bind_ip : 연결할 인터페이스 지정, 3.6부터 기본적으로 localhost에 바인딩
- nounixsocket : 유닉스 도메인 소켓에서 수신을 비활성화
- --noscripting : 서버 측 자바스크립트 코드가 실행되지 않도록 한다.

### 데이터 암호화
- 엔터프라이즈 버전에서 사용할수 있음
- 마스터 키 생성
- 각 데이터베이스에 대한 키 생성
- 데이터베이스 키로 데이터 암호화
- 마스터 키로 데이터베이스 키 암호화

### SSL 연결
- TLS/SSL을 사용한 암호화 지원
- 커뮤니티버전, 엔터프라이즈 버전 둘다 사용 가능
- 네이티브 TLS/SSL 라이브러리 사용, --tlsMode 옵션사용

## 로깅 
- --quiet 옵션 실행X (메시지 발생 억제)
- setParameter 명령을 실행하거나 --setParameter옵션을 사용해 로그레벨을 문자열로 전달
```
> db.adminCommand({"setParameter":1, "logLevel":3})
```
- 디버깅 완료되면 로그레벨을 0으로 돌리자
- 기본적으로 몽고DB는 실행 시간이 100밀리초 이상인 쿼리 정보를 로그에 남긴다.
- 100밀리초가 너무 짧거나 길다면 setProfilingLevel로 임계치를 바꾸자
```
> db.setProfilingLevel(1,500)
```

# 몽고DB 모니터링
- 몽고DB의 메모리 사용 추적하는 방법
- 애플리케이션 성능 지표를 추적하는 방법
- 복제상의 문제를 진단하는 방법
> 몽고DB 옵스 매니저, 아틀라스 등 사용하여 모니터링

## 메모리 사용 모니터링
- 상주메모리(RESIDENT) : 램에서 명시적으로 소유하는 메모리
  - EX) 도큐먼트를 쿼리하고, 메모리상에 페지이되면, 해당 페이지는 몽고DB 상주 메모리에 추가 
- 가상메모리 : 운영체제가 제공하는 추상화로 물리적 스토리지 세부사항을 소프트웨어 프로세스로부터 숨김. 일반적으로 대응 메모리 크기의 두배
- 대응메모리(MAPPED) : 몽고DB가 접근한 모든데이터를 포함, 일반적으로 데이터셋 크기 정도

### 페이지 폴트 추적
- 찾는 데이터가 얼마나 자주 램에 존재하지 않았는지 알려줌
- serverStatus 결과의 page_fault 필드로 확인

### 입출력 대기
- 페이지 폴트는 일반적으로 CPU가 디스크를 기다리면서 얼마나 오랫동안 IDLE(유휴)상태 인지와 관련되며 이를 `입출력 대기(I/O wait)` 라 부른다.

### 복제 모니터링
- 복제지연과 oplog 길이를 추적
- 세컨더리가 프라이머리를 따라잡을수 없을때 복제지연 발생
- 프라미어리가 쓰기를 수행하는 속도만큼 세컨더리가 쓰기를 복제하지 못하면 지연값은 0이 아니게 된다.
> 컬렉션에 _id 인덱스가 있는지 확인하자
- 각 멤버의 oplog 길이 추적도 중요한 복제.
- 프라이머리가 될수 있는 멤버는 oplog가 하루보다 길어야 한다.

