# 샤딩
- 여러 장비에 걸쳐 데이터를 분할하는 과정, 때때로 파티셔닝 이라는 용어로도 사용
- 각 장비에 데이터의 서브셋을 넣음으로써, 더 많은 수의 덜 강력한 장비로 더 많은 데이터를 저장하고 더 많은 부하를 처리할 수 있다.
- 컬렉션을 분할한 조각 데이터(청그)를 저장하며, 복제 세트로 구성될 수 있다.
- 더 자주 접근하는 데이터를 성능이 더 좋은 하드웨어에 배치할 수 있다.
- 지역에 따라 데이터셋을 분할해 주로 접근하는 애플리케이션 서버와 가까운 컬렉션에서 도큐먼트의 서브셋을 찾을 수 있다. ex) 사용자가 특정 로케일(locale)을 기반으로 할때
- 몽고 DB는 자동 샤딩을 지원
- 샤딩은 개발 및 운영 측면에서 몽고DB를 구성하는 가장 어렵고 복잡한 방법이다. 모니터링할 구성 요소가 많고, 클러스터에서 데이터가 자동으로 옮겨 다니기 때문이다.
- 몽고DB 옵스 매니저나 몽고DB 아틀라스 를 사용하여 컴퓨팅 인프라 제어


## 클러스터 구성요소
![image](https://github.com/wjdrlans5000/mongoDB/assets/62735399/315381de-354e-4cc2-90a6-a227af96fded)
- 몽고DB 샤딩을 통해, 많은 장비(샤드)의 클러스터를 생성하고, 각 샤드에 데이터 서브셋을 넣음으로써 데이터를 쪼갤 수 있다.
- 샤딩의 목적은 2개, 3개, 10개, 심지어 1000개의 샤드 클러스터가 하나의 장비처럼 보이게 하는 것이다.
- 이러한 세부 사항을 애플케이션으로부터 숨기기 위해, 샤드 앞단에 있는 `mongos`라는 `라우팅 프로세스`를 실행한다.
- 샤딩 설정 및 이미지 출처 : https://urame.tistory.com/entry/%EB%AA%BD%EA%B3%A0%EB%94%94%EB%B9%84mongodb-%EC%83%A4%EB%93%9Cshard-%EC%84%A4%EC%A0%95

## mongos
- 어떤 샤드가 어떤 데이터를 포함하는지 알려주는 `컨텐츠 목차` 가 있다.
- 애플리케이션은 라우터에 연결해 정상적으로 요청을 발행할 수 있다.
- 라우터는 어떤 데이터가 어떤 샤드에 있는지 알기 때문에 요청을 적절한 샤드로 전달할 수 있다.
- 요청에 대한 응답이 있으면 라우터는 응답을 수집하고 필요하다면 통합하여 애플리케이션으로 되돌려보낸다.
- 상세 내용 참고 : https://dontbesatisfied.tistory.com/9

## 단일 장비 클러스터에서의 샤딩
- 먼저 mongo 셀을 시작한다
```
$ mongo --nodb --norc
```
- 클러스터를 만들기위해 ShardingTest 클래스를 사용한다.
- mongo 셸에서 다음을 실행한다.
```
st = ShardingTest({
    name:"one-min-shards",
    chunkSize:1,
    shards:2,
    rs:{
        nodes:3,
        oplogSize:10
    },
    other:{
        enableBalancer:true
    }
});
```

| 옵션 | 설명 |
|---|---|
| name | 샤드 클러스터에 대한 레이블 |
| shards | 클러스터가 2개의 샤드로 구성되도록 지정 |
| rs | 각 샤드를 oplogSize가 10MiB인 3-노드 복제 셋으로 정의 |
| other | 클러스터가 스핀 업되면 밸런서를 활성화하도록 ShardingTest에 지시 <br>-> 데이터가 두 샤드에 균등하게 분산된다. |

### ShardingTest의 작업 수행
1) 두개의 샤드가 있는 새 클러스터를 생성한다.
2) 각 샤드는 복제셋이다.
3) 복제 프로토콜을 설정하는데 필요한 옵션으로 복제 셋을 구성하고 각 노드를 시작한다.
4) mongos를 시작해 전체 샤드의 요청을 관리하며, 클라이언트는 독립형 mongod와 통신하듯 클러스터와 상호작용 할수 있다.(어느정도는)
5) 구성 서버에 대한 추가 복제 셋을 시작하며 이 서버는 올바른 샤드로 전달하는데 필요한 라우팅 테이블 정보를 유지한다.

### ShardingTest가 클러스터 설정을 마치면 연결 가능한 실행중인 프로세스는 10개다.
- 노드 3개로 구성된 복제셋 2개
- 노드 3개로 구성된 구성 서버 복제 셋 1개
- mongos 1개

### mongos 연결


